<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vocabulary Explorer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script   src="https://code.jquery.com/jquery-3.7.1.min.js"   integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="   crossorigin="anonymous"></script>
</head>
<body>
    <script>
        var search = new URLSearchParams(window.location.search).get("wn_search")
        var API_URL = "https://itwewina.altlab.dev/api/"
    </script>
    <nav class="navbar navbar-expand-sm bg-primary-subtle" >
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Vocabulary Explorer</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <form class="container-fluid" role="search" action="" method="get">
                    <fieldset id="formFieldset" class="d-flex">
                        <input class="form-control me-2" name="wn_search" placeholder="nitona towihkân / Search a category..." type="search" aria-label="search">
                        <button type="submit" class="btn btn-outline-dark">Search Wordnet...</button>
                    </fieldset>
                </form>
            </div>
        </div>
    </nav>
    <main class="container">
    <div class="container-sm d-none pt-3" id="content">
    <div class="row sticky-top bg-white">
        <div class="col">
            <h5 id="hyperyms_title">nikâwîsak / aunts</h5>
        </div>
        <div class="col">
            <h5>nîcisânak / siblings</h5>
        </div>
        <div class="col">
            <h5 id="hyponyms_title"><br/></h5>
        </div>
    </div>
    <div class="row" id="entryMessage">
        <p>Please wait while we search for the results...</p>
    </div>
    <div class="row">
        <div class="col overflow-scroll">
            <div class="list-group" id="hypernymResults">
            </div>
        </div>
        <div class="col overflow-scroll">
            <div class="accordion" id="accordionContents">     
            </div>   
        </div>
        <div class="col overflow-scroll">
            <div class="list-group" id="hyponymResults">
            </div>
        </div>
    </div>
    </div>
    </main>
    <!-- end -->
    <script>
    if(search){
        $("#content").removeClass("d-none").addClass("d-block")
        $.getJSON(API_URL+"wordnet-index-search/?wn="+encodeURIComponent(search), (response) => {
        let candidates = response["results"]
        if (candidates && (candidates.length == 1)){
            search = candidates[0]["synset"]
            definition = candidates[0]["definition"]

            $.getJSON(API_URL+"wordnet-synset/?wn="+encodeURIComponent(search), (synset) => {
                $("#entryMessage").empty()
                let parents = synset["hypernyms"].map((x) => x["synset"])            
                let hypernyms = synset["hypernyms"].concat(
                    synset["hyponyms_of_hypernyms_of_hypernyms"].filter((x) => !parents.includes(x["synset"])))
                var siblings = synset["hyponyms_of_hypernyms"]
                siblings = synset["hyponyms_of_hypernyms"].filter((x) => x["synset"] == search).concat(
                    synset["hyponyms_of_hypernyms"].filter((x) => x["synset"] != search)
                )

                siblings.forEach( (sibling, sibling_index) =>{
                    let header = $("<h2>", {
                        "class": "accordion-header"
                    })
                    let id_name = "collapse-sibling-"+sibling_index
                    let title = $("<button>", {
                        "class": "accordion-button" + (sibling["synset"] == search ? "" : " collapsed"),
                        "type": "button",
                            "data-bs-toggle": "collapse",
                        "data-bs-target": "#"+id_name,
                            "aria-expanded": sibling["synset"] == search,
                            "aria-controls": id_name,
                        })
                    title.append("<div class=\"d-flex container ps-0\"><div class=\"ms-0 me-auto\">"+sibling["synset"]+"</div><span class=\"badge text-bg-light rounded-pill\">"+sibling["wordform_count"]+"</span></div>")

                    header.append(title)
                    let contents = $("<div>", {
                        "id": id_name,
                        "class": "accordion-collapse collapse" + (sibling["synset"] == search ? " show" : ""),
                        "data-bs-parent": "#accordionContents"
                    })
                    let body = $("<div>", {
                        "class": "accordion-body"
                    })
                    contents.append(body)
                    body.append($("<p />").append($("<small />").text(sibling["definition"])))

                    let listgroup = $("<div>", {
                        "class": "list-group",
                        // "id": "wordResults"
                    })
                    body.append(listgroup)
                    let item = $("<div>",{
                        class:"accordion-item"
                    })
                    item.append(header)
                    item.append(contents)
                    $("#accordionContents").append(item)
                    listgroup.append("(Loading, please wait ...)")
                    // Now get the JSON and fill up the siblings
                    $.getJSON(API_URL+"wordnet-index/?wn="+encodeURIComponent(sibling["synset"]), (words) => {
                        listgroup.empty()
                        for (const word of words["results"]){
                            let value = $("<a />",{
                                "href": "http://itwewina.altlab.app"+word["lemma_wordform"]["lemma_url"],
                                "class": "list-group-item"
                            })
                            let heading = $("<div>", {
                                "class": "d-flex w-100 justify-content-between"
                            })
                            heading.append("<h5 class=\"mb-1\">"+word["wordform_text"]+"</h5>")
                            value.append(heading)
                            for (const defn of word["definitions"]){
                                value.append("<p class=\"mb-1\">"+defn["text"]+"</p>")
                            }
                            let synsets = word["lemma_wordform"]["synsets"].filter((x) => x != search)
                            if (synsets.length > 0) {
                                let alternatives = $("<small />", {"text": "Also one of "})
                                for (const synset of synsets){
                                    alternatives.append($("<a />", {
                                        "href": "?wn_search="+encodeURIComponent(synset),
                                        "text": synset
                                    }))
                                }
                                let container = $("<p />", {
                                    "class": "my-0"
                                })
                                container.append(alternatives)
                                value.append(container)
                            }
                            listgroup.append(value)
                        }
                    listgroup.append("<p>There might be more words in the subcategories of "+sibling["synset"]+".</p>")
                    let hyponym_function = function (name) {
                        // console.log("action on "+id_name)
                        $("#hyponymResults").empty();
                        $("#hyponyms_title").empty();
                        $("#hyponyms_title").append("nitânisak / daughters")
                        let hyponyms  = words["hyponyms"]
                        hyponyms.sort((a, b) => b["wordform_closure_count"] - a["wordform_closure_count"])

                        for (const index of hyponyms){
                            let content = $("<div />",{
                                "class": "list-group-item list-group-item-action" + (index["wordform_closure_count"] > 0 ? (index["wordform_count"] > 0 ? "" : "" ) : " list-group-item-secondary"),
                            });
                            content.append($("<a />",{
                                "href": index["wordform_closure_count"] > 0 ? "?wn_search="+encodeURIComponent(index["synset"]) : "#",
                                "class": "link-dark align-items-start d-flex",
                                "html": "<div class=\"ms-0 me-auto\">"+index["synset"]+"</div>"
                            }).append("<span class=\"badge text-bg-light rounded-pill\">"+index["wordform_count"]+"</span>"))
                            content.append($("<p />").append($("<small />").text(index["definition"])))
                            $("#hyponymResults").append(content)
                        }
                    }
                    $('#'+id_name).on('show.bs.collapse', () => hyponym_function(sibling["synset"]));                    
                    if (sibling["synset"] == search){
                        hyponym_function(search);
                    }
                    })
                });
            if(hypernyms.length > 0){
                for (const hypernym of hypernyms){
                    let synset = hypernym["synset"]
                    let content = $("<div />",{
                        "class": "list-group-item list-group-item-action"+ (parents.includes(synset)? " list-group-item-primary":""),
                    });
                    content.append($("<a />",{
                        "href": "?wn_search="+encodeURIComponent(synset),
                        "class": "link-dark align-items-start d-flex",
                    }).append($("<div />", {
                        "class": "ms-0 me-auto"
                    }).html(parents.includes(synset)? "<b>"+synset+"</b><br /><i>(parent of "+search+")</i>": synset))
                    .append("<span class=\"badge text-bg-light rounded-pill\">"+hypernym["wordform_count"]+"</span>"))
                    
                    content.append($("<p />").append($("<small />").text(hypernym["definition"])))
                    $("#hypernymResults").append(content)
                }
            }
        })} else {
            let table = $("<table class=\"table table-striped\"></table>")
            $("#content").empty().append($("<h3></h3>").text("Your category search produced "+(candidates.length > 0 ? "multiple": "no")+" results")).append(table);
            for (const candidate of candidates){
                table.append($("<tr></tr>").append($("<td></td>").append($("<a />",{
                    "href": "?wn_search="+encodeURIComponent(candidate["synset"]),
                    "text": candidate["synset"]+" ("+candidate["definition"]+")"
                }))))
            }
        }
    })}
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    </body>
    </html>